import json
from tests.abstraction_handling.from_rust_stitch_test import run_compression_for_testing

from transformers import AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained("meta-llama/Meta-Llama-3-8B")

with open("vlmaterial-set/human_200.json", "r") as f:
    code = json.load(f)


_, _, abstrs, rewritten = run_compression_for_testing(
    code,
    iterations=100,
    max_arity=4,
    silent=False,
    verbose_best=True,
    is_pythonm=True,
    use_symvars=False,
)

print(sum(len(tokenizer.encode(x)) for x in code))
print(sum(len(tokenizer.encode(x)) for x in rewritten))


for abstr in abstrs:
    print("*" * 80)
    print(abstr)

with open("out.py", "w") as f:
    f.write("# This file is auto-generated by create.py\n")
    for x in rewritten:
        f.write("#" + "-" * 80 + "\n")
        f.write(x + "\n\n")
